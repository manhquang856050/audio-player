<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Google Drive Audio Player 2.0</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background:#121212; color:#fff; text-align:center; margin:0; padding:20px; }
    h2 { color:#00bcd4; }
    #controls { margin-bottom:16px; }
    input { width:280px; padding:8px; border:none; border-radius:4px; margin-right:6px; }
    button { padding:8px 12px; border:none; background:#00bcd4; color:#fff; border-radius:4px; cursor:pointer; }
    button:hover { background:#0097a7; }
    #fileList { list-style:none; padding:0; margin-top:20px; max-width:720px; margin-left:auto; margin-right:auto; text-align:left; }
    #fileList li { padding:10px; cursor:pointer; background:#1f1f1f; margin-bottom:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
    #fileList li:hover { background:#333; }
    .name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:80%; }
    .meta { font-size:12px; color:#bbb; }
    audio { width:90%; margin-top:18px; max-width:900px; }
    .small { font-size:13px; color:#bbb; margin-top:8px; }
  </style>
</head>
<body>
  <h2>üéß Google Drive Audio Player 2.0</h2>
  <div id="controls">
    <input id="folderInput" type="text" placeholder="Nh·∫≠p ID th∆∞ m·ª•c Google Drive (ho·∫∑c d√°n link ƒë·∫ßy ƒë·ªß)">
    <button id="loadBtn">T·∫£i danh s√°ch</button>
    <button id="refreshBtn" title="T·∫£i l·∫°i danh s√°ch hi·ªán t·∫°i">‚ü≥</button>
  </div>
  <div class="small">Ghi ch√∫: Th∆∞ m·ª•c ph·∫£i ƒë∆∞·ª£c chia s·∫ª <strong>Anyone with the link</strong>.</div>
  <ul id="fileList"></ul>
  <audio id="audioPlayer" controls></audio>

<script>
  // --- C·∫§U H√åNH: d√°n API_KEY m·∫∑c ƒë·ªãnh n·∫øu mu·ªën ---
  const API_KEY = "AIzaSyDmftcVNrcg8QkthjuJh-Ws9jO64Szztzw";
  // Th∆∞ m·ª•c m·∫∑c ƒë·ªãnh (user's folder)
  let FOLDER_ID = "1Ec5Z8pjeOQlTCHg8GuCfkODx4Ifm4ohZ";

  const listEl = document.getElementById('fileList');
  const player = document.getElementById('audioPlayer');
  const folderInput = document.getElementById('folderInput');
  const loadBtn = document.getElementById('loadBtn');
  const refreshBtn = document.getElementById('refreshBtn');

  let playlist = [];
  let current = -1;

  // H·ªó tr·ª£ nhi·ªÅu mime types ph·ªï bi·∫øn
  const MIME_TYPES = [
    "audio/mpeg",
    "audio/wav",
    "audio/mp4",
    "audio/x-m4a",
    "audio/aac",
    "audio/ogg",
    "audio/x-aac",
    "audio/x-wav"
  ];

  function extractFolderId(input) {
    input = input.trim();
    if (!input) return null;
    try {
      const u = new URL(input);
      // n·∫øu d√°n link ƒë·∫ßy ƒë·ªß
      const parts = u.pathname.split('/');
      const idx = parts.indexOf('folders');
      if (idx !== -1 && parts[idx+1]) return parts[idx+1];
    } catch(e){}
    // n·∫øu ng∆∞·ªùi d√πng nh·∫≠p th·∫≥ng id
    return input;
  }

  function buildQuery() {
    const mimeQuery = MIME_TYPES.map(t => `mimeType='${t}'`).join("+or+");
    // request fields include modifiedTime to allow secondary sorting if needed
    return `q='${FOLDER_ID}'+in+parents+and+(${mimeQuery})&fields=files(id,name,mimeType,modifiedTime)&key=${API_KEY}`;
  }

  async function loadFiles() {
    listEl.innerHTML = '<li style="background:transparent;color:#bbb">ƒêang t·∫£i danh s√°ch...</li>';
    try {
      const url = 'https://www.googleapis.com/drive/v3/files?' + buildQuery();
      const res = await fetch(url);
      const data = await res.json();
      if (!data.files || data.files.length === 0) {
        listEl.innerHTML = '<li style="background:transparent;color:#bbb">Kh√¥ng t√¨m th·∫•y file √¢m thanh trong th∆∞ m·ª•c n√†y.</li>';
        return;
      }

      // S·∫Øp x·∫øp theo t√™n (c·∫£m ·ª©ng ti·∫øng Vi·ªát), n·∫øu t√™n gi·ªëng th√¨ theo modifiedTime (m·ªõi nh·∫•t tr∆∞·ªõc)
      const files = data.files.sort((a,b) => {
        const n = a.name.localeCompare(b.name, 'vi', {sensitivity:'base'});
        if (n !== 0) return n;
        // fall back to modifiedTime desc
        return (new Date(b.modifiedTime) - new Date(a.modifiedTime));
      });

      playlist = files.map(f => ({
        id: f.id,
        name: f.name,
        mime: f.mimeType,
        link: `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`
      }));

      // Render
      listEl.innerHTML = '';
      playlist.forEach((file, i) => {
        const li = document.createElement('li');
        const nameDiv = document.createElement('div');
        nameDiv.className = 'name';
        nameDiv.textContent = file.name;
        const metaDiv = document.createElement('div');
        metaDiv.className = 'meta';
        metaDiv.textContent = file.mime;
        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        const playBtn = document.createElement('button');
        playBtn.textContent = '‚ñ∂';
        playBtn.style.marginRight = '8px';
        playBtn.onclick = (e) => { e.stopPropagation(); playFile(i); };
        const dlBtn = document.createElement('button');
        dlBtn.textContent = '‚§ì';
        dlBtn.title = 'M·ªü file tr·ª±c ti·∫øp';
        dlBtn.onclick = (e) => { e.stopPropagation(); window.open(file.link, '_blank'); };
        right.appendChild(playBtn);
        right.appendChild(dlBtn);

        li.appendChild(nameDiv);
        li.appendChild(right);
        li.onclick = () => playFile(i);
        listEl.appendChild(li);
      });

      // auto play first if none playing
      if (playlist.length && current === -1) playFile(0);
    } catch (err) {
      console.error(err);
      listEl.innerHTML = '<li style="background:transparent;color:#f88">L·ªói khi t·∫£i danh s√°ch (xem console ƒë·ªÉ bi·∫øt chi ti·∫øt)</li>';
    }
  }

  function playFile(index) {
    if (!playlist[index]) return;
    current = index;
    player.src = playlist[index].link;
    player.play().catch(err => {
      // M·ªôt s·ªë tr√¨nh duy·ªát c√≥ ch·∫∑n autoplay ‚Äî ch·ªâ c·∫ßn user b·∫•m play l√† ok
      console.warn('play error', err);
    });
    // highlight
    Array.from(listEl.children).forEach((li, i) => {
      li.style.background = i === index ? '#00bcd4' : '#1f1f1f';
    });
  }

  player.addEventListener('ended', () => {
    if (playlist.length === 0) return;
    current = (current + 1) % playlist.length;
    playFile(current);
  });

  loadBtn.onclick = () => {
    const raw = folderInput.value.trim();
    if (!raw) { alert('Vui l√≤ng nh·∫≠p ID th∆∞ m·ª•c ho·∫∑c d√°n link ƒë·∫ßy ƒë·ªß.'); return; }
    const id = extractFolderId(raw);
    if (!id) { alert('Kh√¥ng t√¨m th·∫•y ID trong input. H√£y nh·∫≠p ID ho·∫∑c d√°n link ƒë·∫ßy ƒë·ªß.'); return; }
    FOLDER_ID = id;
    // l∆∞u ch·ªçn th∆∞ m·ª•c v√†o localStorage ƒë·ªÉ l·∫ßn sau m·ªü l·∫°i
    localStorage.setItem('drive_folder_id', FOLDER_ID);
    loadFiles();
  };

  refreshBtn.onclick = () => loadFiles();

  // load stored folder id if c√≥
  const stored = localStorage.getItem('drive_folder_id');
  if (stored) {
    FOLDER_ID = stored;
    folderInput.value = stored;
  } else {
    folderInput.value = FOLDER_ID;
  }

  // initial load
  loadFiles();
</script>
</body>
</html>
